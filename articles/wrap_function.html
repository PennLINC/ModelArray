<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Developing a function for ModelArray.wrap • ModelArray</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Developing a function for ModelArray.wrap">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ModelArray</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/basic_r_intro.html">An intro to R</a></li>
    <li><a class="dropdown-item" href="../articles/container.html">Getting started with containers</a></li>
    <li><a class="dropdown-item" href="../articles/debugging.html">Debugging</a></li>
    <li><a class="dropdown-item" href="../articles/doc_for_developer.html">Developer documentation</a></li>
    <li><a class="dropdown-item" href="../articles/faq.html">FAQ</a></li>
    <li><a class="dropdown-item" href="../articles/installations.html">Installation</a></li>
    <li><a class="dropdown-item" href="../articles/voxel-wise_data.html">Application to voxel-wise data</a></li>
    <li><a class="dropdown-item" href="../articles/walkthrough.html">Example walkthrough</a></li>
    <li><a class="dropdown-item" href="../articles/wrap_function.html">Developing a function for ModelArray.wrap</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Developing a function for ModelArray.wrap</h1>
            
      

      <div class="d-none name"><code>wrap_function.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><code>R</code> offers a ton of wonderful packages for statistical
modeling - more than we could ever hope to officially support with
functions like <code>ModelArray.lm</code> and
<code>ModelArray.gam</code> in <code>ModelArray</code>. Fortunately,
<code>ModelArray.wrap</code> provides a way to run your own function,
which can be arbitrarily complex, while using the efficient looping and
parallelization machinery of <code>ModelArray</code>.</p>
<p>We’ll skip over the making of the .h5 file and phenotypes CSV file,
and directly download the cortical thickness data from the Healthy Brain
Network computed as part of the Reproducible Brain Charts project.</p>
<p>We’ll develop a function that computes the mean cortical thickness
within each site, and then use <code>ModelArray.wrap</code> to run it
across elements.</p>
</div>
<div class="section level2">
<h2 id="step-1--prepare-your-data">Step 1. Prepare your data<a class="anchor" aria-label="anchor" href="#step-1--prepare-your-data"></a>
</h2>
<p>We first create a folder called “myProject” on the Desktop. In a
terminal console:</p>
<pre class="console"><code>$ cd ~/Desktop
$ mkdir myCustomFunction
$ cd myCustomFunction
$ pwd       # print the full path of this folder</code></pre>
<pre class="console"><code>$ wget -cO - https://osf.io/uxc65/download &gt; download.tar.gz
$ tar -xzf download.tar.gz
$ rm download.tar.gz</code></pre>
</div>
<div class="section level2">
<h2 id="step-2--use-modelarray-to-perform-statistical-analysis">Step 2. Use ModelArray to perform statistical analysis<a class="anchor" aria-label="anchor" href="#step-2--use-modelarray-to-perform-statistical-analysis"></a>
</h2>
<p>The next step is to use this HDF5 file and the CSV file we prepared
to perform statistical analysis in R. If you installed RStudio (which we
recommend), then you can simply launch RStudio. All the commands in this
Step 2 section will be run in R.</p>
<div class="section level3">
<h3 id="step-2-1--load-modelarray-package-in-r">Step 2.1. Load ModelArray package in R<a class="anchor" aria-label="anchor" href="#step-2-1--load-modelarray-package-in-r"></a>
</h3>
<p>After you’ve installed <code>ModelArray</code>, here’s how we load
the library:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pennlinc.github.io/ModelArray">ModelArray</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-2-2--create-a-modelarray-class-object">Step 2.2. Create a ModelArray-class object<a class="anchor" aria-label="anchor" href="#step-2-2--create-a-modelarray-class-object"></a>
</h3>
<p>To create a ModelArray-class object that represents the HDF5 file of
fixel-wise data, we need the HDF5 filename and the scalar’s name:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h5_path</span> <span class="op">&lt;-</span> <span class="st">"~/Desktop/myCustomFunction/ConCifti/study-HBN_compression-gzip_chunkmb-4_thickness.h5"</span></span>
<span><span class="co"># create a ModelArray-class object:</span></span>
<span><span class="va">modelarray</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ModelArray.html">ModelArray</a></span><span class="op">(</span><span class="va">h5_path</span>, scalar_types <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"thickness"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># let's check what's in it:</span></span>
<span><span class="va">modelarray</span></span></code></pre></div>
<p>You’ll see:</p>
<pre class="console"><code>ModelArray located at ~/Desktop/myProject/demo_FDC_n100.h5

  Source files:     2336
  Scalars:          thickness
  Analyses:</code></pre>
<p>This shows that there are 2336 source thickness files in this
<code>modelarray</code> you created.</p>
<p>You may take a look at what the scalar matrix looks like by using
<code><a href="../reference/scalars.html">scalars()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># scalar FDC data:</span></span>
<span><span class="fu"><a href="../reference/scalars.html">scalars</a></span><span class="op">(</span><span class="va">modelarray</span><span class="op">)</span><span class="op">[[</span><span class="st">"thickness"</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p>You’ll see:</p>
<pre class="console"><code>&lt;327684 x 2336&gt; DelayedMatrix object of type "double":
          ciftis/sub-NDARAA075AMK_thickness.fsLR_den-164k.dscalar.nii ... ciftis/sub-NDARZZ810LVF_thickness.fsLR_den-164k.dscalar.nii
     [1,]                                                    2.323956   .                                                    3.401824
     [2,]                                                    2.927209   .                                                    2.428174
     [3,]                                                    3.211094   .                                                    2.479505
     [4,]                                                    2.463409   .                                                    3.760944
     [5,]                                                    2.460162   .                                                    2.912316
      ...                                                           .   .                                                           .
[327680,]                                                    2.832996   .                                                    3.066516
[327681,]                                                    2.669299   .                                                    2.912496
[327682,]                                                    2.555752   .                                                    2.510855
[327683,]                                                    2.336970   .                                                    2.472471
[327684,]                                                    2.256365   .                                                    2.293425</code></pre>
<p>Rows are greyordinates <code>(n = 327684)</code>, and column names
are the source filenames <code>(n = 2336)</code>. Each value is a
specific greyordinate’s thickness from a dscalar.nii file.</p>
</div>
<div class="section level3">
<h3 id="step-2-3--load-cohort-phenotypes-csv-file">Step 2.3. Load cohort phenotypes CSV file<a class="anchor" aria-label="anchor" href="#step-2-3--load-cohort-phenotypes-csv-file"></a>
</h3>
<p>We then load the accompanying CSV file:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">csv_path</span> <span class="op">&lt;-</span> <span class="st">"~/Desktop/myCustomFunction/ConCifti/study-HBN_desc-participants_thickness.csv"</span></span>
<span><span class="co"># load the CSV file:</span></span>
<span><span class="va">phenotypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">csv_path</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">phenotypes</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">phenotypes</span><span class="op">)</span></span></code></pre></div>
<p>This CSV file comes from RBC but is reduced to include only the
subjects with thickness data. It also includes rich phenotype
information.</p>
</div>
<div class="section level3">
<h3 id="step-2-4--perform-statistical-analysis">Step 2.4. Perform statistical analysis<a class="anchor" aria-label="anchor" href="#step-2-4--perform-statistical-analysis"></a>
</h3>
<p>With both <code>modelarray</code> and data frame
<code>phenotypes</code> set up, we can now perform the statistical
analysis.</p>
<p>We need to write a function that we can use within
<code>ModelArray.wrap</code> to compute what we want. It can be tricky
to figure out exactly what you want to compute and how to make sure your
function returns the correct output. We can use a convenience function
from <code>ModelArray</code> to see what a dataframe looks like for a
single element.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/exampleElementData.html">exampleElementData</a></span><span class="op">(</span><span class="va">modelarray</span>, scalar <span class="op">=</span> <span class="st">"thickness"</span>, i_element <span class="op">=</span> <span class="fl">12345</span>, phenotypes <span class="op">=</span> <span class="va">phenotypes</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">example_df</span><span class="op">)</span></span></code></pre></div>
<p>This is a rich dataframe! It contains the cortical thickness for all
subjects in the study at vertex 12345. It also contains the subject ID,
sex, age, and other covariates.</p>
<p>We can explore this single element like we would any dataframe:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">example_df</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">thickness</span>, color <span class="op">=</span> <span class="va">study_site</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This looks cool. There is apparently a site effect, so let’s write a
function that computes a mean cortical thickness within each site. We’ll
also compute an anova on site and get the statistics/p-values. For now
we’ll get the values we want into a dataframe, then we’ll write the
function.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">site_means</span> <span class="op">&lt;-</span> <span class="va">example_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">study_site</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>mean_thickness <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">thickness</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># write them into "thickness_{study_site}" columns</span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">study_site</span>, values_from <span class="op">=</span> <span class="va">mean_thickness</span>, names_glue <span class="op">=</span> <span class="st">"thickness_{study_site}"</span><span class="op">)</span></span>
<span><span class="va">site_means</span></span></code></pre></div>
<p>This looks good. Now let’s do the anova and get the
statistics/p-values.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">site_anova</span> <span class="op">&lt;-</span> <span class="va">example_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">thickness</span> <span class="op">~</span> <span class="va">study_site</span>, data <span class="op">=</span> <span class="va">.</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/anova.html" class="external-link">anova</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    partial_eta_sq <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span></span>
<span>      <span class="va">term</span> <span class="op">!=</span> <span class="st">"Residuals"</span>,</span>
<span>      <span class="va">sumsq</span> <span class="op">/</span> <span class="op">(</span><span class="va">sumsq</span> <span class="op">+</span> <span class="va">sumsq</span><span class="op">[</span><span class="va">term</span> <span class="op">==</span> <span class="st">"Residuals"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      <span class="cn">NA_real_</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">!=</span> <span class="st">"Residuals"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">term</span>, <span class="va">df</span>, <span class="va">sumsq</span>, <span class="va">meansq</span>, <span class="va">statistic</span>, <span class="va">p.value</span>, <span class="va">partial_eta_sq</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span></span>
<span>    names_from <span class="op">=</span> <span class="va">term</span>,</span>
<span>    values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">sumsq</span>, <span class="va">meansq</span>, <span class="va">statistic</span>, <span class="va">p.value</span>, <span class="va">partial_eta_sq</span><span class="op">)</span>,</span>
<span>    names_glue <span class="op">=</span> <span class="st">"{term}.{.value}"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">site_anova</span></span></code></pre></div>
<p>Combining the two we get the full function we want. Absolutely
critical here is that your function needs a single argument named
<code>data</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_mean_thickness_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">site_means</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">study_site</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>mean_thickness <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">thickness</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">study_site</span>, values_from <span class="op">=</span> <span class="va">mean_thickness</span>, names_glue <span class="op">=</span> <span class="st">"thickness_{study_site}"</span><span class="op">)</span></span>
<span>  <span class="va">site_anova</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">thickness</span> <span class="op">~</span> <span class="va">study_site</span>, data <span class="op">=</span> <span class="va">.</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/anova.html" class="external-link">anova</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      partial_eta_sq <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span></span>
<span>        <span class="va">term</span> <span class="op">!=</span> <span class="st">"Residuals"</span>,</span>
<span>        <span class="va">sumsq</span> <span class="op">/</span> <span class="op">(</span><span class="va">sumsq</span> <span class="op">+</span> <span class="va">sumsq</span><span class="op">[</span><span class="va">term</span> <span class="op">==</span> <span class="st">"Residuals"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>        <span class="cn">NA_real_</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">!=</span> <span class="st">"Residuals"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">term</span>, <span class="va">df</span>, <span class="va">sumsq</span>, <span class="va">meansq</span>, <span class="va">statistic</span>, <span class="va">p.value</span>, <span class="va">partial_eta_sq</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span></span>
<span>      names_from <span class="op">=</span> <span class="va">term</span>,</span>
<span>      values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">sumsq</span>, <span class="va">meansq</span>, <span class="va">statistic</span>, <span class="va">p.value</span>, <span class="va">partial_eta_sq</span><span class="op">)</span>,</span>
<span>      names_glue <span class="op">=</span> <span class="st">"{term}.{.value}"</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">site_means</span>, <span class="va">site_anova</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">my_mean_thickness_fun</span><span class="op">(</span><span class="va">example_df</span><span class="op">)</span></span></code></pre></div>
<p>This looks great! We can test that the function will work in the
<code>ModelArray</code> looping machinery by running it on a single
element.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/analyseOneElement.wrap.html">analyseOneElement.wrap</a></span><span class="op">(</span></span>
<span>  <span class="fl">12345</span>,</span>
<span>  <span class="va">my_mean_thickness_fun</span>,</span>
<span>  <span class="va">modelarray</span>,</span>
<span>  <span class="va">phenotypes</span>,</span>
<span>  <span class="st">"thickness"</span>,</span>
<span>  num.subj.lthr <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  flag_initiate <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  on_error <span class="op">=</span> <span class="st">"debug"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This will print the column names that will be retrieved from the
function when it’s run in the <code>ModelArray</code> looping machinery.
It looks good, so we can run it on all the greyordinates:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_wrap</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ModelArray.wrap.html">ModelArray.wrap</a></span><span class="op">(</span></span>
<span>  FUN <span class="op">=</span> <span class="va">my_mean_thickness_fun</span>,</span>
<span>  data <span class="op">=</span> <span class="va">modelarray</span>,</span>
<span>  phenotypes <span class="op">=</span> <span class="va">phenotypes</span>,</span>
<span>  scalar <span class="op">=</span> <span class="st">"thickness"</span>,</span>
<span>  n_cores <span class="op">=</span> <span class="fl">8</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>On my laptop this took about 15 minutes.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">res_wrap</span><span class="op">)</span></span></code></pre></div>
<pre class="console"><code>  element_id thickness_HBNsiteCBIC thickness_HBNsiteCUNY thickness_HBNsiteRU thickness_HBNsiteSI study_site.df study_site.sumsq study_site.meansq study_site.statistic study_site.p.value study_site.partial_eta_sq
1          0              3.108483              3.009349            3.063119            2.692335             3         45.52142         15.173806             59.35110       5.688104e-37                0.07093606
2          1              2.618739              2.673533            2.494077            2.324791             3         24.51961          8.173205             28.88297       2.474739e-18                0.03582533
3          2              3.111822              3.056225            2.983709            2.812225             3         23.59899          7.866330             19.95448       9.059350e-13                0.02502795
4          3              3.669784              3.621715            3.054638            3.329743             3        186.55051         62.183503             83.32945       3.261715e-51                0.09682010
5          4              2.790135              2.729325            2.494522            2.444265             3         53.34644         17.782147             55.42033       1.336311e-34                0.06655069
6          5              2.996483              3.043458            2.785565            2.650955             3         40.25648         13.418828             41.60603       3.458560e-26                0.05080478</code></pre>
<p>We now save the results data frame into the original h5 file:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/writeResults.html">writeResults</a></span><span class="op">(</span><span class="va">h5_path</span>, df.output <span class="op">=</span> <span class="va">res_wrap</span>, analysis_name <span class="op">=</span> <span class="st">"anova_and_means"</span><span class="op">)</span></span></code></pre></div>
<p>Notice that the the analysis name specified in argument
<code>analysis_name</code> will be used in <code>ConCifti</code> in the
next step when converting results back to dscalar.nii file format. It’ll
also be used as the prefix of the mif files to be saved.</p>
</div>
</div>
<div class="section level2">
<h2 id="step-3--convert-back-to-dscalar-nii-file-format">Step 3. Convert back to dscalar.nii file format<a class="anchor" aria-label="anchor" href="#step-3--convert-back-to-dscalar-nii-file-format"></a>
</h2>
<div class="section level3">
<h3 id="step-3-1--convert-the-statistical-results-into-mif-file-format-using-confixel">Step 3.1. Convert the statistical results into mif file format using
ConFixel<a class="anchor" aria-label="anchor" href="#step-3-1--convert-the-statistical-results-into-mif-file-format-using-confixel"></a>
</h3>
<p>We now use <code>ConFixel</code> to convert the results into a list
of mif files:</p>
<pre class="console"><code>$ ciftistats_write \
  --cohort-file ${HOME}/Desktop/myCustomFunction/ConCifti/study-HBN_desc-participants_thickness.csv \
  --relative-root ${HOME}/Desktop/myCustomFunction \
  --analysis-name anova_and_means \
  --input-hdf5 ${HOME}/Desktop/myCustomFunction/ConCifti/study-HBN_compression-gzip_chunkmb-4_thickness.h5 \
  --output-dir ${HOME}/Desktop/myCustomFunction/anova_and_means \
  --example-cifti ${HOME}/Desktop/myCustomFunction/ConCifti/example_fsLR_den-164k.dscalar.nii

# remember to use your specific path in --relative-root;
# we recommend it's a full path too!</code></pre>
<p>After it’s done, in the main folder <code>myCustomFunction</code>,
there will be a new folder called <code>anova_and_means</code> and
converted result <code>dscalar.nii</code>files are in this new
folder:</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Chenying Zhao, Tinashe Tapera, Matthew Cieslak, Theodore Satterthwaite.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
