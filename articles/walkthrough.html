<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Example walkthrough • ModelArray</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Example walkthrough">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ModelArray</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/installations.html">Installation</a></li>
    <li><a class="dropdown-item" href="../articles/walkthrough.html">Example walkthrough</a></li>
    <li><a class="dropdown-item" href="../articles/container.html">Getting started with containers</a></li>
    <li><a class="dropdown-item" href="../articles/voxel-wise_data.html">Application to voxel-wise data</a></li>
    <li><a class="dropdown-item" href="../articles/doc_for_developer.html">Developer documentation</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Example walkthrough</h1>
            
      

      <div class="d-none name"><code>walkthrough.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this example walkthrough, we will use some example
<strong>fixel</strong>-wise data to demonstrate the steps of using
<code>ModelArray</code> and its companion python package,
<code>ConFixel</code>. Analysis for <strong>voxel</strong>-wise data
follows similar steps, but there are several differences when execution;
for more details regarding application to voxel-wise data, please refer
to <code><a href="../articles/voxel-wise_data.html">vignette("voxel-wise_data")</a></code> page. We also provide hints
for voxel-wise data throughout current walkthrough.</p>
<p>By following the <code><a href="../articles/installations.html">vignette("installations")</a></code> page, to
perform statistical analysis for fixel-wise data, you should have
successfully installed <code>ModelArray</code>, <code>ConFixel</code>,
and <code>MRtrix</code>. We expect that <code>ConFixel</code> has been
installed in a conda environment called <code>modelarray</code>.</p>
<p>We will first prepare the data and convert it into the format that
<code>ModelArray</code> requires (Step 1), then we’ll use
<code>ModelArray</code> to perform the statistical analysis (Step 2).
Finally we will convert the results into original file format and view
them (Step 3).</p>
</div>
<div class="section level2">
<h2 id="step-1--prepare-your-data">Step 1. Prepare your data<a class="anchor" aria-label="anchor" href="#step-1--prepare-your-data"></a>
</h2>
<p>We first create a folder called “myProject” on the Desktop. In a
terminal console:</p>
<pre class="console"><code>$ cd ~/Desktop
$ mkdir myProject
$ cd myProject
$ pwd       # print the full path of this folder</code></pre>
<p>On a linux machine, you’ll see the printed full path of this folder
is <code>/home/&lt;username&gt;/Desktop/myProject</code></p>
<p>Here, we provide some demo fixel-wise data. This demo data includes
100 subjects aged 8-22 years from the Philadelphia Neurodevelopmental
Cohort (PNC) <a href="https://doi.org/10.1016/j.neuroimage.2013.07.064" class="external-link">Satterthwaite et
al., 2014</a>. This data was generated by following fixel-based analysis
<a href="https://doi.org/10.1016/j.neuroimage.2016.09.029" class="external-link">Raffelt et
al., 2017</a> and are ready for fixel-wise statistical analysis. You can
get the data by running the following:</p>
<pre class="console"><code>$ wget -cO - https://osf.io/tce9d/download &gt; download.tar.gz
$ tar -xzf download.tar.gz
$ rm download.tar.gz</code></pre>
<blockquote>
<p>Hint for voxel-wise data for Step 1: Data preparation and conversion
steps are different for voxel-wise data. Please refer to <a href="https://github.com/PennLINC/ConFixel/blob/main/notebooks/walkthrough_voxel-wise_data.md" class="external-link">here</a>
for how to do so.</p>
</blockquote>
<div class="section level3">
<h3 id="step-1-1--overview-of-the-data-organization">Step 1.1. Overview of the data organization<a class="anchor" aria-label="anchor" href="#step-1-1--overview-of-the-data-organization"></a>
</h3>
<p>The data is organized in the following way:</p>
<pre class="console"><code>~/Desktop/myProject
├── cohort_FDC_n100.csv
├── FDC
│   ├── directions.mifs
│   ├── index.mif
│   ├── sub-010b693.mif
│   ├── sub-0133f31.mif
│   ├── sub-063fd82.mif
│   ├── ...
└── ...
</code></pre>
<p>In this demo data, the fixel-wise metric is <code>FDC</code>. As you
can see here, in folder <code>FDC</code>, besides subject-level
fixel-wise data in template space (e.g. <code>sub-010b693.mif</code>),
there are also the files <code>index.mif</code> and
<code>directions.mif</code>. These two files provide important
information of the fixel locations - you can learn about their
definitions <a href="https://userdocs.mrtrix.org/en/dev/fixel_based_analysis/fixel_directory_format.html" class="external-link">here</a>.</p>
</div>
<div class="section level3">
<h3 id="step-1-2--prepare-a-csv-file-of-cohort-phenotypes">Step 1.2. Prepare a CSV file of cohort phenotypes<a class="anchor" aria-label="anchor" href="#step-1-2--prepare-a-csv-file-of-cohort-phenotypes"></a>
</h3>
<p>In addition to fixel-wise data, we also need a CSV file of cohort
phenotypes. This file will be used by both <code>ConFixel</code> and
<code>ModelArray</code>. Here’s an example:
<code>cohort_FDC_n100.csv</code>:</p>
<table class="table">
<colgroup>
<col width="17%">
<col width="8%">
<col width="6%">
<col width="22%">
<col width="17%">
<col width="28%">
</colgroup>
<thead><tr class="header">
<th align="center">subject_id</th>
<th align="center">Age</th>
<th align="center">sex</th>
<th align="center">dti64MeanRelRMS</th>
<th align="center"><strong><em>scalar_name</em></strong></th>
<th align="center"><strong><em>source_file</em></strong></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">sub-6fee490</td>
<td align="center">8.83</td>
<td align="center">2</td>
<td align="center">0.863669</td>
<td align="center">FDC</td>
<td align="center">FDC/sub-6fee490.mif</td>
</tr>
<tr class="even">
<td align="center">sub-647f86c</td>
<td align="center">8.50</td>
<td align="center">2</td>
<td align="center">1.775610</td>
<td align="center">FDC</td>
<td align="center">FDC/sub-647f86c.mif</td>
</tr>
<tr class="odd">
<td align="center">sub-4b3ffe0</td>
<td align="center">8.42</td>
<td align="center">1</td>
<td align="center">1.911350</td>
<td align="center">FDC</td>
<td align="center">FDC/sub-4b3ffe0.mif</td>
</tr>
<tr class="even">
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
</tr>
</tbody>
</table>
<p>The table in this CSV file includes these columns:</p>
<ul>
<li>Required: <code>scalar_name</code>, which tells us what metric is
being analyzed, and <code>source_file</code>, which tells us which mif
file will be used for this subject</li>
<li>Covariates: the covariates we want to include in the statistical
model. Here <code>dti64MeanRelRMS</code> is a measure of in-scanner
motion, which we want to control for.</li>
</ul>
</div>
<div class="section level3">
<h3 id="step-1-3--convert-data-into-an-hdf5-file-using-confixel">Step 1.3. Convert data into an HDF5 file using ConFixel<a class="anchor" aria-label="anchor" href="#step-1-3--convert-data-into-an-hdf5-file-using-confixel"></a>
</h3>
<p>One of the reasons why <code>ModelArray</code> is memory efficient is
it takes advantages of Hierarchical Data Format 5 (HDF5) file format.
The extension of this file format is <code>.h5</code>. In short, an HDF5
file stores large datasets hierarchically. Let’s use
<code>ConFixel</code> to convert the list of mif files into an HDF5
file. In the terminal console:</p>
<pre class="console"><code>$ conda activate modelarray
$ confixel \
    --index-file FDC/index.mif \
    --directions-file FDC/directions.mif \
    --cohort-file cohort_FDC_n100.csv \
    --relative-root /home/&lt;username&gt;/Desktop/myProject \
    --output-hdf5 demo_FDC_n100.h5

# remember to use your specific path in --relative-root;
# we recommend it's a full path too!</code></pre>
<p>As mentioned before, here we take
<code>/home/&lt;username&gt;/Desktop/myProject</code> as the main
folder; you won’t need to repeat paths once you’ve used the
<code>--relative-root</code> flag.</p>
<p>When running <code>confixel</code>, you will see a moving progress
bar. When it finishes, it looks like this:</p>
<pre class="console"><code>Extracting .mif data...
100%|█████████████████████████████████████████| 100/100 [00:03&lt;00:00, 30.33it/s]</code></pre>
<p>Now you got the converted HDF5 file <code>demo_FDC_n100.h5</code> in
folder <code>~/Desktop/myProject</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="step-2--use-modelarray-to-perform-statistical-analysis">Step 2. Use ModelArray to perform statistical analysis<a class="anchor" aria-label="anchor" href="#step-2--use-modelarray-to-perform-statistical-analysis"></a>
</h2>
<p>The next step is to use this HDF5 file and the CSV file we prepared
to perform statistical analysis in R. If you installed RStudio (which we
recommend), then you can simply launch RStudio. All the commands in this
Step 2 section will be run in R.</p>
<blockquote>
<p>Hint for voxel-wise data for Step 2: You can follow the same steps
here. Note that each “element” is a <em>voxel</em> now, instead of a
<em>fixel</em>. Make sure you replace the scalar name, covariates, file
paths etc with yours. In addition, as voxel-wise data may have
subject-specific masks, you can also tailor the lower threshold of
number of subjects when applying <code><a href="../reference/ModelArray.lm.html">ModelArray.lm()</a></code> and
<code><a href="../reference/ModelArray.gam.html">ModelArray.gam()</a></code>. See
<code><a href="../articles/voxel-wise_data.html">vignette("voxel-wise_data")</a></code> page for more.</p>
</blockquote>
<div class="section level3">
<h3 id="step-2-1--load-modelarray-package-in-r">Step 2.1. Load ModelArray package in R<a class="anchor" aria-label="anchor" href="#step-2-1--load-modelarray-package-in-r"></a>
</h3>
<p>After you’ve installed <code>ModelArray</code>, here’s how we load
the library:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pennlinc.github.io/ModelArray">ModelArray</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-2-2--create-a-modelarray-class-object">Step 2.2. Create a ModelArray-class object<a class="anchor" aria-label="anchor" href="#step-2-2--create-a-modelarray-class-object"></a>
</h3>
<p>To create a ModelArray-class object that represents the HDF5 file of
fixel-wise data, we need the HDF5 filename and the scalar’s name:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># filename of example fixel-wise data (.h5 file):</span></span>
<span><span class="va">h5_path</span> <span class="op">&lt;-</span> <span class="st">"~/Desktop/myProject/demo_FDC_n100.h5"</span></span>
<span><span class="co"># create a ModelArray-class object:</span></span>
<span><span class="va">modelarray</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ModelArray.html">ModelArray</a></span><span class="op">(</span><span class="va">h5_path</span>, scalar_types <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FDC"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># let's check what's in it:</span></span>
<span><span class="va">modelarray</span></span></code></pre></div>
<p>You’ll see:</p>
<pre class="console"><code>ModelArray located at ~/Desktop/myProject/demo_FDC_n100.h5

  Source files:     100
  Scalars:          FDC
  Analyses:</code></pre>
<p>This shows that there are 100 source FDC files in this
<code>modelarray</code> you created.</p>
<p>You may take a look at what the scalar matrix looks like by using
<code><a href="../reference/scalars.html">scalars()</a></code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># scalar FDC data:</span></span>
<span><span class="fu"><a href="../reference/scalars.html">scalars</a></span><span class="op">(</span><span class="va">modelarray</span><span class="op">)</span><span class="op">[[</span><span class="st">"FDC"</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p>You’ll see:</p>
<pre class="console"><code>&lt;602229 x 100&gt; matrix of class DelayedMatrix and type "double":
          FDC/sub-6fee490.mif FDC/sub-647f86c.mif ... FDC/sub-fb15b55.mif FDC/sub-063fd82.mif
     [1,]          0.24264026          0.15679701   .          0.00454893          0.16528498
     [2,]          0.04573315          0.30895054   .          0.25159708          0.33469012
     [3,]          0.18638037          0.26985332   .          0.26864439          0.26453218
     [4,]          0.13169773          0.36824343   .          0.19793315          0.27003124
     [5,]          0.22650713          0.16020685   .          0.10235775          0.41848758
      ...                   .                   .   .                   .                   .
[602225,]           0.1058939           0.1262244   .           0.2559175           0.2618564
[602226,]           0.2273949           0.8616257   .           0.4713631           0.5220432
[602227,]           0.1899130           1.2083211   .           0.2561999           0.1202894
[602228,]           0.0000000           1.3483975   .           0.0000000           0.0000000
[602229,]           0.1275258           0.5184639   .           0.2065310           0.1833882</code></pre>
<p>Rows are fixels <code>(n = 602229)</code>, and column names are the
source filenames <code>(n = 100)</code>. Each value is a specific
fixel’s FDC from a mif file.</p>
</div>
<div class="section level3">
<h3 id="step-2-3--load-cohort-phenotypes-csv-file">Step 2.3. Load cohort phenotypes CSV file<a class="anchor" aria-label="anchor" href="#step-2-3--load-cohort-phenotypes-csv-file"></a>
</h3>
<p>We then load the accompanying CSV file:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># filename of example fixel-wise data (.h5 file):</span></span>
<span><span class="va">csv_path</span> <span class="op">&lt;-</span> <span class="st">"~/Desktop/myProject/cohort_FDC_n100.csv"</span></span>
<span><span class="co"># load the CSV file:</span></span>
<span><span class="va">phenotypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">csv_path</span><span class="op">)</span></span></code></pre></div>
<p>As this CSV file already provides sufficient covariates ready for
analysis below, we don’t need to do extra work on it.</p>
</div>
<div class="section level3">
<h3 id="step-2-4--perform-statistical-analysis">Step 2.4. Perform statistical analysis<a class="anchor" aria-label="anchor" href="#step-2-4--perform-statistical-analysis"></a>
</h3>
<p>With both <code>modelarray</code> and data frame
<code>phenotypes</code> set up, we can now perform the statistical
analysis. At present, <code>ModelArray</code> supports linear models as
well as generalized additive models (GAM) with and without penalized
splines, which are particularly useful for studying nonlinear effects in
lifespan data.</p>
<p>Let’s start with linear model <code><a href="../reference/ModelArray.lm.html">ModelArray.lm()</a></code>. We first
need a formula defining the model. We mainly want to test how fixel FDC
changes with age in adolescence, assuming it’s a linear relationship. We
also add sex and in-scanner motion quantification
<code>dti64MeanRelRMS</code> as covariates. Intercept will be
automatically added. We first try it out on first 100 fixels before we
running on all fixels:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># formula:</span></span>
<span><span class="va">formula.lm</span> <span class="op">&lt;-</span> <span class="va">FDC</span> <span class="op">~</span> <span class="va">Age</span> <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">dti64MeanRelRMS</span></span>
<span><span class="co"># run linear model fitting with ModelArray.lm() on the first 100 fixels:</span></span>
<span><span class="va">mylm.try</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ModelArray.lm.html">ModelArray.lm</a></span><span class="op">(</span><span class="va">formula.lm</span>, <span class="va">modelarray</span>, <span class="va">phenotypes</span>, <span class="st">"FDC"</span>,</span>
<span>  element.subset <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>You’ll see:</p>
<pre class="console"><code>subset: default
weights: default
na.action: default
method: default
model: default
x: default
y: default
qr: default
singular.ok: default
contrasts: default
offset: default
Fitting element-wise linear models for FDC
initiating....
looping across elements....
  |++++++++++++++++++++++++++++++++++++++++++++++++++| 100% elapsed=06s</code></pre>
<p>It first printed how several options for <code>lm</code> were set,
then worked on the model fitting. Let’s check the first 6 rows of the
results, i.e. results of the first 6 fixels:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">mylm.try</span><span class="op">)</span></span></code></pre></div>
<p>You’ll see:</p>
<table class="table">
<colgroup>
<col width="3%">
<col width="5%">
<col width="3%">
<col width="3%">
<col width="6%">
<col width="5%">
<col width="4%">
<col width="4%">
<col width="7%">
<col width="5%">
<col width="6%">
<col width="3%">
<col width="4%">
<col width="3%">
<col width="4%">
<col width="6%">
<col width="7%">
<col width="5%">
<col width="4%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="center">element_id</th>
<th align="center">Intercept.estimate</th>
<th align="center">Age.estimate</th>
<th align="center">sex.estimate</th>
<th align="center">dti64MeanRelRMS.estimate</th>
<th align="center">Intercept.statistic</th>
<th align="center">Age.statistic</th>
<th align="center">sex.statistic</th>
<th align="center">dti64MeanRelRMS.statistic</th>
<th align="center">Intercept.p.value</th>
<th align="center">Intercept.p.value.fdr</th>
<th align="center">Age.p.value</th>
<th align="center">Age.p.value.fdr</th>
<th align="center">sex.p.value</th>
<th align="center">sex.p.value.fdr</th>
<th align="center">dti64MeanRelRMS.p.value</th>
<th align="center">dti64MeanRelRMS.p.value.fdr</th>
<th align="center">model.adj.r.squared</th>
<th align="center">model.p.value</th>
<th align="center">model.p.value.fdr</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">0</td>
<td align="center">0.1574554</td>
<td align="center">0.0005079</td>
<td align="center">0.0108810</td>
<td align="center">-0.0067989</td>
<td align="center">2.049316</td>
<td align="center">0.1281586</td>
<td align="center">0.4091826</td>
<td align="center">-0.1915206</td>
<td align="center">0.0431593</td>
<td align="center">0.0644169</td>
<td align="center">0.8982916</td>
<td align="center">0.9946718</td>
<td align="center">0.6833172</td>
<td align="center">0.8444836</td>
<td align="center">0.8485222</td>
<td align="center">0.9952377</td>
<td align="center">-0.0287295</td>
<td align="center">0.9715544</td>
<td align="center">0.9715544</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">0.2678434</td>
<td align="center">0.0026411</td>
<td align="center">-0.0180576</td>
<td align="center">-0.0001476</td>
<td align="center">2.956456</td>
<td align="center">0.5651542</td>
<td align="center">-0.5758993</td>
<td align="center">-0.0035272</td>
<td align="center">0.0039163</td>
<td align="center">0.0081590</td>
<td align="center">0.5732873</td>
<td align="center">0.9946718</td>
<td align="center">0.5660309</td>
<td align="center">0.8143135</td>
<td align="center">0.9971930</td>
<td align="center">0.9971930</td>
<td align="center">-0.0242065</td>
<td align="center">0.8822558</td>
<td align="center">0.9588263</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="center">0.3808456</td>
<td align="center">0.0000743</td>
<td align="center">-0.0247444</td>
<td align="center">-0.0313025</td>
<td align="center">3.697746</td>
<td align="center">0.0139822</td>
<td align="center">-0.6941623</td>
<td align="center">-0.6577973</td>
<td align="center">0.0003622</td>
<td align="center">0.0016322</td>
<td align="center">0.9888732</td>
<td align="center">0.9946718</td>
<td align="center">0.4892568</td>
<td align="center">0.7900378</td>
<td align="center">0.5122426</td>
<td align="center">0.9952377</td>
<td align="center">-0.0196619</td>
<td align="center">0.7793740</td>
<td align="center">0.9519001</td>
</tr>
<tr class="even">
<td align="center">3</td>
<td align="center">0.3462063</td>
<td align="center">-0.0015211</td>
<td align="center">-0.0165382</td>
<td align="center">-0.0110064</td>
<td align="center">3.870265</td>
<td align="center">-0.3296572</td>
<td align="center">-0.5341844</td>
<td align="center">-0.2663025</td>
<td align="center">0.0001982</td>
<td align="center">0.0010433</td>
<td align="center">0.7423772</td>
<td align="center">0.9946718</td>
<td align="center">0.5944489</td>
<td align="center">0.8143135</td>
<td align="center">0.7905774</td>
<td align="center">0.9952377</td>
<td align="center">-0.0260748</td>
<td align="center">0.9220699</td>
<td align="center">0.9588263</td>
</tr>
<tr class="odd">
<td align="center">4</td>
<td align="center">0.3831223</td>
<td align="center">-0.0012686</td>
<td align="center">-0.0498778</td>
<td align="center">-0.0169274</td>
<td align="center">3.608630</td>
<td align="center">-0.2316505</td>
<td align="center">-1.3574013</td>
<td align="center">-0.3450802</td>
<td align="center">0.0004912</td>
<td align="center">0.0017543</td>
<td align="center">0.8173026</td>
<td align="center">0.9946718</td>
<td align="center">0.1778363</td>
<td align="center">0.6969094</td>
<td align="center">0.7307890</td>
<td align="center">0.9952377</td>
<td align="center">-0.0085248</td>
<td align="center">0.5418155</td>
<td align="center">0.9519001</td>
</tr>
<tr class="even">
<td align="center">5</td>
<td align="center">0.3618128</td>
<td align="center">-0.0008015</td>
<td align="center">-0.0274349</td>
<td align="center">-0.0088992</td>
<td align="center">3.207225</td>
<td align="center">-0.1377359</td>
<td align="center">-0.7026583</td>
<td align="center">-0.1707341</td>
<td align="center">0.0018214</td>
<td align="center">0.0044425</td>
<td align="center">0.8907376</td>
<td align="center">0.9946718</td>
<td align="center">0.4839691</td>
<td align="center">0.7900378</td>
<td align="center">0.8647922</td>
<td align="center">0.9952377</td>
<td align="center">-0.0250535</td>
<td align="center">0.9006376</td>
<td align="center">0.9588263</td>
</tr>
</tbody>
</table>
<p>As you can see, for each fixel, by default,
<code><a href="../reference/ModelArray.lm.html">ModelArray.lm()</a></code> returns:</p>
<ul>
<li>Several statistics for the <code>Intercept</code>, <code>Age</code>,
<code>sex</code>, and motion <code>dti64MeanRelRMS</code>. These
statistics include:
<ul>
<li>estimation of Intercept and the coefficients or slopes of other
terms</li>
<li>
<em>t</em>-statistics</li>
<li>
<em>p</em>-value</li>
<li>
<em>p</em>-value after FDR correction</li>
</ul>
</li>
<li>Several statistics for the linear model, including:
<ul>
<li>adjusted <em>R</em>-squared</li>
<li>
<em>p</em>-value</li>
<li>
<em>p</em>-value after FDR correction</li>
</ul>
</li>
</ul>
<p>You may request more comprehensive statistics with the argument
<code>full.outputs=TRUE</code>.</p>
<p>Now let’s try out <code><a href="../reference/ModelArray.gam.html">ModelArray.gam()</a></code>. The example commands
are as below. Compared to a linear model, GAMs flexibly model linear and
nonlinear effects by using smooth functions; penalty can also be applied
to avoid over-fitting. Here we use <code>s(Age)</code> to indicate that
this will be fit as a spline smooth function. The <code>k=4</code>
argument sets an upper limit on the degrees of freedom for this smooth
function. Restricted maximum likelihood (<code>REML</code>) is used for
fitting.</p>
<p>In addition to default FDR correction, we can also request Bonferroni
correction.</p>
<p>We still first try it out on first 100 fixels:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># formula:</span></span>
<span><span class="va">formula.gam</span> <span class="op">&lt;-</span> <span class="va">FDC</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">Age</span>, k <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">dti64MeanRelRMS</span></span>
<span><span class="co"># run GAM fitting with ModelArray.gam() on the first 100 fixels:</span></span>
<span><span class="va">mygam.try</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ModelArray.gam.html">ModelArray.gam</a></span><span class="op">(</span><span class="va">formula.gam</span>, <span class="va">modelarray</span>, <span class="va">phenotypes</span>, <span class="st">"FDC"</span>,</span>
<span>  element.subset <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>,</span>
<span>  correct.p.value.smoothTerms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fdr"</span>, <span class="st">"bonferroni"</span><span class="op">)</span>,</span>
<span>  correct.p.value.parametricTerms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fdr"</span>, <span class="st">"bonferroni"</span><span class="op">)</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"REML"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>You’ll see:</p>
<pre class="console"><code>The formula requested: FDC ~ s(Age, k = 4) + sex + dti64MeanRelRMS
s(Age):   k = 4;   fx = FALSE (default);   bs = tp (default)
method = REML (default: GCV.Cp)
Fitting element-wise GAMs for FDC
initiating....
looping across elements....
  |++++++++++++++++++++++++++++++++++++++++++++++++++| 100% elapsed=14s</code></pre>
<p>The GAM results of the first 6 fixels:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">mygam.try</span><span class="op">)</span></span></code></pre></div>
<p>You’ll see:</p>
<table class="table">
<colgroup>
<col width="2%">
<col width="3%">
<col width="3%">
<col width="5%">
<col width="4%">
<col width="4%">
<col width="3%">
<col width="5%">
<col width="4%">
<col width="3%">
<col width="6%">
<col width="4%">
<col width="6%">
<col width="5%">
<col width="2%">
<col width="5%">
<col width="3%">
<col width="5%">
<col width="8%">
<col width="6%">
<col width="3%">
</colgroup>
<thead><tr class="header">
<th align="center">element_id</th>
<th align="center">s_Age.statistic</th>
<th align="center">s_Age.p.value</th>
<th align="center">s_Age.p.value.bonferroni</th>
<th align="center">s_Age.p.value.fdr</th>
<th align="center">Intercept.estimate</th>
<th align="center">sex.estimate</th>
<th align="center">dti64MeanRelRMS.estimate</th>
<th align="center">Intercept.statistic</th>
<th align="center">sex.statistic</th>
<th align="center">dti64MeanRelRMS.statistic</th>
<th align="center">Intercept.p.value</th>
<th align="center">Intercept.p.value.bonferroni</th>
<th align="center">Intercept.p.value.fdr</th>
<th align="center">sex.p.value</th>
<th align="center">sex.p.value.bonferroni</th>
<th align="center">sex.p.value.fdr</th>
<th align="center">dti64MeanRelRMS.p.value</th>
<th align="center">dti64MeanRelRMS.p.value.bonferroni</th>
<th align="center">dti64MeanRelRMS.p.value.fdr</th>
<th align="center">model.dev.expl</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">0</td>
<td align="center">0.3919938</td>
<td align="center">0.6396933</td>
<td align="center">1</td>
<td align="center">0.8545475</td>
<td align="center">0.1662467</td>
<td align="center">0.0085795</td>
<td align="center">-0.0015008</td>
<td align="center">3.732225</td>
<td align="center">0.3229002</td>
<td align="center">-0.0419848</td>
<td align="center">0.0003225</td>
<td align="center">0.0322463</td>
<td align="center">0.0003839</td>
<td align="center">0.7474771</td>
<td align="center">1</td>
<td align="center">0.8591691</td>
<td align="center">0.9665985</td>
<td align="center">1</td>
<td align="center">0.9962095</td>
<td align="center">0.0177441</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">0.3193919</td>
<td align="center">0.5732950</td>
<td align="center">1</td>
<td align="center">0.8308623</td>
<td align="center">0.3083310</td>
<td align="center">-0.0180576</td>
<td align="center">-0.0001477</td>
<td align="center">5.843594</td>
<td align="center">-0.5758990</td>
<td align="center">-0.0035275</td>
<td align="center">0.0000001</td>
<td align="center">0.0000070</td>
<td align="center">0.0000001</td>
<td align="center">0.5660311</td>
<td align="center">1</td>
<td align="center">0.8033110</td>
<td align="center">0.9971928</td>
<td align="center">1</td>
<td align="center">0.9971928</td>
<td align="center">0.0068301</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="center">0.0342444</td>
<td align="center">0.9559484</td>
<td align="center">1</td>
<td align="center">0.9956698</td>
<td align="center">0.3821904</td>
<td align="center">-0.0252837</td>
<td align="center">-0.0300008</td>
<td align="center">6.376270</td>
<td align="center">-0.7091046</td>
<td align="center">-0.6289196</td>
<td align="center">0.0000000</td>
<td align="center">0.0000006</td>
<td align="center">0.0000000</td>
<td align="center">0.4799807</td>
<td align="center">1</td>
<td align="center">0.7749732</td>
<td align="center">0.5308975</td>
<td align="center">1</td>
<td align="center">0.9962095</td>
<td align="center">0.0143341</td>
</tr>
<tr class="even">
<td align="center">3</td>
<td align="center">0.1086654</td>
<td align="center">0.7424475</td>
<td align="center">1</td>
<td align="center">0.9286274</td>
<td align="center">0.3228876</td>
<td align="center">-0.0165382</td>
<td align="center">-0.0110065</td>
<td align="center">6.197683</td>
<td align="center">-0.5341825</td>
<td align="center">-0.2663045</td>
<td align="center">0.0000000</td>
<td align="center">0.0000014</td>
<td align="center">0.0000000</td>
<td align="center">0.5944502</td>
<td align="center">1</td>
<td align="center">0.8033110</td>
<td align="center">0.7905759</td>
<td align="center">1</td>
<td align="center">0.9962095</td>
<td align="center">0.0050187</td>
</tr>
<tr class="odd">
<td align="center">4</td>
<td align="center">0.0536680</td>
<td align="center">0.8173638</td>
<td align="center">1</td>
<td align="center">0.9504230</td>
<td align="center">0.3636743</td>
<td align="center">-0.0498777</td>
<td align="center">-0.0169276</td>
<td align="center">5.881524</td>
<td align="center">-1.3573985</td>
<td align="center">-0.3450840</td>
<td align="center">0.0000001</td>
<td align="center">0.0000059</td>
<td align="center">0.0000001</td>
<td align="center">0.1778372</td>
<td align="center">1</td>
<td align="center">0.7013344</td>
<td align="center">0.7307862</td>
<td align="center">1</td>
<td align="center">0.9962095</td>
<td align="center">0.0220368</td>
</tr>
<tr class="even">
<td align="center">5</td>
<td align="center">0.0189684</td>
<td align="center">0.8908133</td>
<td align="center">1</td>
<td align="center">0.9682754</td>
<td align="center">0.3495258</td>
<td align="center">-0.0274349</td>
<td align="center">-0.0088991</td>
<td align="center">5.319820</td>
<td align="center">-0.7026591</td>
<td align="center">-0.1707324</td>
<td align="center">0.0000007</td>
<td align="center">0.0000678</td>
<td align="center">0.0000012</td>
<td align="center">0.4839686</td>
<td align="center">1</td>
<td align="center">0.7749732</td>
<td align="center">0.8647935</td>
<td align="center">1</td>
<td align="center">0.9962095</td>
<td align="center">0.0060088</td>
</tr>
</tbody>
</table>
<p>As you can see, for each fixel, here <code><a href="../reference/ModelArray.gam.html">ModelArray.gam()</a></code>
returns:</p>
<ul>
<li>Several statistics for the smooth term <code>s(Age)</code>,
including <em>F</em>-statistics and <em>p</em>-values (and those after
FDR and Bonferroni correction);</li>
<li>Several statistics for the parametric terms <code>Intercept</code>,
<code>sex</code>, and motion <code>dti64MeanRelRMS</code>, including
estimation of the coefficient (or the slope), <em>t</em>-statistics, and
<em>p</em>-values (and those after FDR and Bonferroni correction);</li>
<li>One statistic for the model: <code>dev.expl</code>, which is the
proportion of the null deviance explained by the model.</li>
</ul>
<p>For more options, please view pages for <code><a href="../reference/ModelArray.lm.html">ModelArray.lm()</a></code>
and <code><a href="../reference/ModelArray.gam.html">ModelArray.gam()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="step-2-5--a-full-run-and-saving-the-results">Step 2.5. A full run and saving the results<a class="anchor" aria-label="anchor" href="#step-2-5--a-full-run-and-saving-the-results"></a>
</h3>
<p>Previous examples only ran on a small subset of the fixels. Now we’ll
formally run across all fixels and save the results. Because running all
fixels will take a substantial amount of time, here we only run the
linear model.</p>
<p>Notice that the command below uses the default value of
<code>element.subset=NULL</code> so that all fixels will be analyzed.
Also notice that, to speed up, we’re requesting 4 CPU cores to run in
parallel. You may adjust this number based on how many CPU cores you
have on your machine. On a Linux machine with Intel(R) Xeon(R) 10th Gen
CPU @ 2.81GHz and using 4 CPU cores, it takes around 2.5 hours to
finish.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run linear model fitting with ModelArray.lm() on the all fixels:</span></span>
<span><span class="va">mylm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ModelArray.lm.html">ModelArray.lm</a></span><span class="op">(</span><span class="va">formula.lm</span>, <span class="va">modelarray</span>, <span class="va">phenotypes</span>, <span class="st">"FDC"</span>,</span>
<span>  n_cores <span class="op">=</span> <span class="fl">4</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We now save the results data frame into the original h5 file:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/writeResults.html">writeResults</a></span><span class="op">(</span><span class="va">h5_path</span>, df.output <span class="op">=</span> <span class="va">mylm</span>, analysis_name <span class="op">=</span> <span class="st">"results_lm"</span><span class="op">)</span></span></code></pre></div>
<p>Notice that the the analysis name specified in argument
<code>analysis_name</code> will be used in <code>ConFixel</code> in the
next step when converting results back to fixel mif file format. It’ll
also be used as the prefix of the mif files to be saved.</p>
<p>We can even check out the saved results in the h5 file (this is
optional):</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create a new ModelArray-class object:</span></span>
<span><span class="va">modelarray_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ModelArray.html">ModelArray</a></span><span class="op">(</span></span>
<span>  filepath <span class="op">=</span> <span class="va">h5_path</span>, scalar_types <span class="op">=</span> <span class="st">"FDC"</span>,</span>
<span>  analysis_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"results_lm"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">modelarray_new</span></span></code></pre></div>
<p>You’ll see:</p>
<pre class="console"><code>ModelArray located at ~/Desktop/myProject/demo_FDC_n100.h5

  Source files:     100
  Scalars:          FDC
  Analyses:         results_lm</code></pre>
<p>The <code>results_lm</code> is shown up here.</p>
</div>
</div>
<div class="section level2">
<h2 id="step-3--check-out-the-result-images">Step 3. Check out the result images<a class="anchor" aria-label="anchor" href="#step-3--check-out-the-result-images"></a>
</h2>
<blockquote>
<p>Hint for voxel-wise data for Step 3: Data conversion and result
viewing are different for voxel-wise data. Please refer to <a href="https://github.com/PennLINC/ConFixel/blob/main/notebooks/walkthrough_voxel-wise_data.md" class="external-link">here</a>
for how to do so.</p>
</blockquote>
<div class="section level3">
<h3 id="step-3-1--convert-the-statistical-results-into-mif-file-format-using-confixel">Step 3.1. Convert the statistical results into mif file format using
ConFixel<a class="anchor" aria-label="anchor" href="#step-3-1--convert-the-statistical-results-into-mif-file-format-using-confixel"></a>
</h3>
<p>We now use <code>ConFixel</code> to convert the results into a list
of mif files:</p>
<pre class="console"><code>$ conda activate modelarray   # activate the conda environment we created
$ fixelstats_write \
  --index-file FDC/index.mif \
  --directions-file FDC/directions.mif \
  --cohort-file cohort_FDC_n100.csv \
  --relative-root /home/&lt;username&gt;/Desktop/myProject \
  --analysis-name results_lm \
  --input-hdf5 demo_FDC_n100.h5 \
  --output-dir results_lm

# remember to use your specific path in --relative-root;
# we recommend it's a full path too!</code></pre>
<p>After it’s done, in the main folder <code>myProject</code>, there
will be a new folder called <code>results_lm</code>, and converted
result mif files are in this new folder:</p>
<pre class="console"><code>results_lm/
├── directions.mif
├── index.mif
├── results_lm_Age.1m.p.value.fdr.mif
├── results_lm_Age.1m.p.value.mif
├── results_lm_Age.estimate.mif
├── results_lm_Age.p.value.fdr.mif
├── results_lm_Age.p.value.mif
├── results_lm_Age.statistic.mif
├── results_lm_dti64MeanRelRMS.1m.p.value.fdr.mif
├── results_lm_dti64MeanRelRMS.1m.p.value.mif
├── results_lm_dti64MeanRelRMS.estimate.mif
├── results_lm_dti64MeanRelRMS.p.value.fdr.mif
├── results_lm_dti64MeanRelRMS.p.value.mif
├── results_lm_dti64MeanRelRMS.statistic.mif
├── results_lm_element_id.mif
├── results_lm_Intercept.1m.p.value.fdr.mif
├── ...
├── results_lm_model.1m.p.value.fdr.mif
├── results_lm_model.1m.p.value.mif
├── results_lm_model.adj.r.squared.mif
├── results_lm_model.p.value.fdr.mif
├── results_lm_model.p.value.mif
├── results_lm_sex.1m.p.value.fdr.mif
├── ...

0 directories, 32 files</code></pre>
<p>Here, <code>1m.p.value.*</code> means it’s the
<code>1 - p-value</code> image.</p>
<!-- may not be able to change above p in backquotes into italic... -->
</div>
<div class="section level3">
<h3 id="step-3-2--view-the-results-in-mrtrixs-mrview">Step 3.2. View the results in MRtrix’s MRView<a class="anchor" aria-label="anchor" href="#step-3-2--view-the-results-in-mrtrixs-mrview"></a>
</h3>
<p>You can launch MRView from the terminal with <code>mrview</code>:</p>
<pre class="console"><code># Suppose you're in myProject folder:
$ cd results_lm   # switch to results folder
$ mrview</code></pre>
<p>Click File -&gt; Open, select <code>index.mif</code>. Then click
Tools -&gt; Fixel plot, you’ll see a side panel of “Fixel plot”. Within
this side panel, click button “Open fixel image” (see below, highlighted
in red):</p>
<center>
<div class="float">
<img src="mrview_fixel_plot_panel_open.PNG" alt="Open fixel image"><div class="figcaption">Open fixel image</div>
</div>
</center>
<p>From there, select <code>index.mif</code> file again. You’ll see
colored <code>directions.mif</code>. Now you can choose which image to
display. Click the filename next to “colour by”, select
<code>results_lm_Age.estimate.mif</code>; then click the button next to
“threshold by”, select <code>results_lm_model.p.value.fdr.mif</code>,
check/tick the option of upper limit, then enter “0.005”. You may change
the view by clicking “View” in the upper panel. Below is an example
view:</p>
<center>
<div class="float">
<img src="mrview_results_lm_demo_FDC_n100.PNG" alt="An example view"><div class="figcaption">An example view</div>
</div>
</center>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Chenying Zhao, Tinashe Tapera, Matthew Cieslak, Theodore Satterthwaite.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
